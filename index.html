<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Surfer Updates Tracking</title>
  <!-- Tabulator CSS -->
  <link
    href="https://unpkg.com/tabulator-tables@5.4.4/dist/css/tabulator.min.css"
    rel="stylesheet"
  />
  <style>
    :root {
      --page-bg: #f0f0f0;
      --table-bg: #ffffff;
      --header-bg: #00796b;
      --header-color: #ffffff;
      --stripe-even: #f9f9f9;
      --stripe-odd: #ffffff;
      --hover-bg: #c8e6c9;
      --border: #dddddd;
      --text: #333333;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body {
      height: 100%; width: 100%;
      font-family: Arial, sans-serif;
      background: var(--page-bg);
      color: var(--text);
    }
    #app {
      display: flex;
      flex-direction: column;
      height: 100vh;
      width: 100vw;
    }
    #app header {
      background: var(--header-bg);
      color: var(--header-color);
      text-align: center;
      padding: 15px;
      font-size: 1.5em;
      flex-shrink: 0;
    }
    #table {
      flex: 1;
      background: var(--table-bg);
      padding: 10px;
      overflow: auto;
    }
    #file-input-wrapper {
      display: none;
      padding: 10px;
      text-align: center;
      color: var(--text);
      background: var(--table-bg);
    }

    /* Tabulator light theme */
    .tabulator {
      border: 1px solid var(--border) !important;
      border-radius: 4px !important;
      background: var(--table-bg) !important;
    }
    .tabulator-header {
      background: var(--header-bg) !important;
      color: var(--header-color) !important;
      font-weight: bold !important;
      border-bottom: 2px solid var(--border) !important;
    }
    .tabulator-header-filter input {
      background: var(--stripe-even) !important;
      color: var(--text) !important;
      border: 1px solid var(--border) !important;
      padding: 4px !important;
    }
    .tabulator-col, .tabulator-cell {
      border-right: 1px solid var(--border) !important;
    }
    .tabulator-col:last-child, .tabulator-row .tabulator-cell:last-child {
      border-right: none !important;
    }
    .tabulator-row:nth-child(even) {
      background: var(--stripe-even) !important;
    }
    .tabulator-row:nth-child(odd) {
      background: var(--stripe-odd) !important;
    }
    .tabulator-row:hover {
      background: var(--hover-bg) !important;
      color: #000 !important;
    }
    .tabulator-group-header {
      background: var(--header-bg) !important;
      color: var(--header-color) !important;
      font-weight: bold !important;
      border-bottom: 1px solid var(--border) !important;
    }
    .tabulator-cell {
      padding: 6px !important;
      font-size: 0.9em;
    }
  </style>
</head>
<body>
  <div id="app">
    <header>Surfer Updates Tracking</header>
    <div id="table">Loading…</div>
    <div id="file-input-wrapper">
      <p>Couldn’t auto-load. Please choose your Excel file:</p>
      <input type="file" id="file-input" accept=".xlsx" />
    </div>
  </div>

  <!-- Dependencies -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
  <script src="https://unpkg.com/tabulator-tables@5.4.4/dist/js/tabulator.min.js"></script>

  <script>
    // Excel serial → JS Date
    function excelDateToJSDate(serial) {
      return new Date((serial - 25569) * 86400 * 1000);
    }

    // Render the table
    function renderTable(data) {
      document.getElementById("table").style.display = "";
      document.getElementById("file-input-wrapper").style.display = "none";

      new Tabulator("#table", {
        data,
        layout: "fitColumns",
        autoColumns: false,
        groupBy: "Site name",
        groupStartOpen: false,
        groupToggleElement: true,
        groupHeader: (val, count) => `${val} (${count})`,
        initialSort: [{ column: "Update Date", dir: "desc" }],
        columns: [
          { title: "Site name",        field: "Site name",        headerFilter: "input" },
          { title: "Surfer Version",   field: "Surfer Version",   headerFilter: "input" },
          { title: "Update Date",      field: "Update Date",      sorter: "date", formatter: "datetime",
            formatterParams:{ outputFormat:"DD/MM/YYYY" }, headerFilter:"input" },
          { title: "Uwamp Version",    field: "Uwamp Version",    headerFilter: "input" },
          { title: "MySQL Version",    field: "Mysql Version",    headerFilter: "input" },
          { title: "Work assigned by", field: "Work assigned by", headerFilter: "input" },
          { title: "Work related to",  field: "Work related to",  headerFilter: "input" },
          { title: "Changes applied",  field: "Chages applied",    headerFilter: "input" },
          { title: "Comments",         field: "Comments",         headerFilter: "input" },
        ],
      });
    }

    // Parse workbook buffer
    function processWorkbook(buffer) {
      const wb = XLSX.read(buffer, { type: "array" });
      const ws = wb.Sheets[wb.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "" });
      const hdrIdx = rows.findIndex(r => r[0].toString().trim() === "Site name");
      if (hdrIdx < 0) {
        alert('Cannot find header row starting with "Site name".');
        return;
      }
      const headers = rows[hdrIdx];
      const raw = rows.slice(hdrIdx + 1)
        .filter(r => r.some(c => c.toString().trim() !== ""));
      const data = raw.map(r => {
        const obj = {};
        r.forEach((c,i) => {
          let v = c;
          if (headers[i] === "Update Date" && typeof c === "number") {
            v = excelDateToJSDate(c);
          }
          obj[headers[i]] = v;
        });
        return obj;
      });
      renderTable(data);
    }

    // Fallback file picker
    function showPicker() {
      document.getElementById("table").style.display = "none";
      document.getElementById("file-input-wrapper").style.display = "";
      document.getElementById("file-input")
        .addEventListener("change", e => {
          const f = e.target.files[0];
          if (!f) return;
          const fr = new FileReader();
          fr.onload = ev => processWorkbook(ev.target.result);
          fr.readAsArrayBuffer(f);
        });
    }

    // Init: try fetch, else picker
    function initApp() {
      fetch("surfer_updates.xlsx")
        .then(r => { if (!r.ok) throw new Error(r.statusText); return r.arrayBuffer(); })
        .then(processWorkbook)
        .catch(err => {
          console.warn("Auto-load failed:", err);
          showPicker();
        });
    }

    window.addEventListener("DOMContentLoaded", initApp);
  </script>
</body>
</html>
