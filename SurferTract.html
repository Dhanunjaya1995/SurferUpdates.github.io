<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Surfer Updates Tracking</title>
  <!-- Tabulator CSS -->
  <link
    href="https://unpkg.com/tabulator-tables@5.4.4/dist/css/tabulator.min.css"
    rel="stylesheet"
  />
  <style>
    :root {
      --bg: #1e1e1e;
      --surface: #2e2e2e;
      --accent: #00796b;
      --accent-light: #009688;
      --text: #e0e0e0;
      --text-muted: #aaa;
      --error: #d32f2f;
    }
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #login, #app {
      background: var(--surface);
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.5);
      width: 90%;
      max-width: 500px;
    }
    h1 {
      margin-top: 0;
      text-align: center;
      color: var(--accent-light);
    }
    label {
      display: block;
      margin: 15px 0 5px;
      font-size: 0.9em;
      color: var(--text-muted);
    }
    input[type="text"],
    input[type="password"] {
      width: 100%;
      padding: 8px;
      background: #383838;
      border: 1px solid var(--accent);
      border-radius: 4px;
      color: var(--text);
      font-size: 1em;
    }
    button {
      width: 100%;
      padding: 10px;
      margin-top: 20px;
      background: var(--accent);
      border: none;
      border-radius: 4px;
      color: #fff;
      font-size: 1em;
      cursor: pointer;
    }
    button:hover {
      background: var(--accent-light);
    }
    .error {
      color: var(--error);
      margin-top: 10px;
      text-align: center;
    }

    /* App-level styles */
    #table {
      margin-top: 20px;
      border: 2px solid var(--accent);
      border-radius: 8px;
      overflow: hidden;
      height: 70vh;
      background: var(--surface);
    }
    .tabulator-header {
      background: var(--accent) !important;
      color: #fff !important;
    }
    .tabulator-row:nth-child(even) {
      background-color: #383838 !important;
    }
    .tabulator-row:nth-child(odd) {
      background-color: #2e2e2e !important;
    }
    .tabulator-row:hover {
      background-color: var(--accent-light) !important;
    }
    .tabulator-group-header {
      background-color: var(--accent-dark) !important;
      color: var(--accent-light) !important;
      font-weight: bold;
    }
    #file-input-wrapper {
      text-align: center;
      margin-top: 20px;
      color: var(--text-muted);
    }
  </style>
</head>
<body>

  <!-- LOGIN PAGE -->
  <div id="login">
    <h1>Surfer Updates Login</h1>
    <label for="user">Username</label>
    <input id="user" type="text" autocomplete="username" />
    <label for="pass">Password</label>
    <input id="pass" type="password" autocomplete="current-password" />
    <button id="btnLogin">Log In</button>
    <div id="loginError" class="error" style="display:none;">
      Invalid credentials
    </div>
  </div>

  <!-- MAIN APP (hidden until login succeeds) -->
  <div id="app" style="display:none; width:100%; max-width:1200px;">
    <h1>Surfer Updates Tracking</h1>
    <div id="table">Loading…</div>
    <div id="file-input-wrapper" style="display:none;">
      <p>Couldn’t auto-load. Please choose your Excel file:</p>
      <input type="file" id="file-input" accept=".xlsx" />
    </div>
  </div>

  <!-- Dependencies -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
  <script src="https://unpkg.com/tabulator-tables@5.4.4/dist/js/tabulator.min.js"></script>

  <script>
    // --- LOGIN LOGIC ---
    const loginDiv = document.getElementById("login");
    const appDiv   = document.getElementById("app");
    document.getElementById("btnLogin").addEventListener("click", () => {
      const u = document.getElementById("user").value.trim();
      const p = document.getElementById("pass").value.trim();
      fetch("credentials.json")
        .then(r => r.json())
        .then(creds => {
          if (u === creds.username && p === creds.password) {
            loginDiv.style.display = "none";
            appDiv.style.display   = "";
            initApp();
          } else {
            document.getElementById("loginError").style.display = "";
          }
        })
        .catch(() => {
          document.getElementById("loginError").innerText = "Error loading credentials";
          document.getElementById("loginError").style.display = "";
        });
    });

    // --- APP LOGIC (runs after successful login) ---
    function excelDateToJSDate(s) {
      return new Date((s - 25569) * 86400 * 1000);
    }

    function renderTable(data) {
      document.getElementById("table").style.display = "";
      document.getElementById("file-input-wrapper").style.display = "none";
      new Tabulator("#table", {
        data,
        layout: "fitColumns",
        groupBy: "Site name",
        groupStartOpen: false,
        groupToggleElement: true,
        groupHeader: (v, c) => `${v} (${c})`,
        initialSort: [{ column: "Update Date", dir: "desc" }],
        columns: [
          { title: "Site name",        field: "Site name",       headerFilter: "input", frozen: true, width: 150 },
          { title: "Surfer Version",   field: "Surfer Version",  headerFilter: "input", width: 120 },
          { title: "Update Date",      field: "Update Date",     sorter:"date", formatter:"datetime",
            formatterParams:{outputFormat:"dd/MM/yyyy"}, headerFilter:"input", width: 130 },
          { title: "Uwamp Version",    field: "Uwamp Version",   headerFilter: "input", width: 120 },
          { title: "MySQL Version",    field: "Mysql Version",   headerFilter: "input", width: 120 },
          { title: "Work assigned by", field: "Work assigned by", headerFilter: "input", width: 180 },
          { title: "Work related to",  field: "Work related to",  headerFilter: "input", width: 160 },
          { title: "Changes applied",  field: "Chages applied",   headerFilter: "input", width: 250 },
          { title: "Comments",         field: "Comments",        headerFilter: "input", width: 300 },
        ],
      });
    }

    function processWorkbook(buffer) {
      const wb = XLSX.read(buffer, { type: "array" });
      const ws = wb.Sheets[wb.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "" });
      const hdrIndex = rows.findIndex(r => r[0].trim() === "Site name");
      if (hdrIndex < 0) {
        alert('Cannot find header row starting with "Site name".');
        return;
      }
      const headers = rows[hdrIndex];
      const raw = rows.slice(hdrIndex + 1)
        .filter(r => r.some(c => c.toString().trim() !== ""));
      const data = raw.map(r => {
        const obj = {};
        r.forEach((c,i) => {
          let v = c;
          if (headers[i] === "Update Date" && typeof c === "number") v = excelDateToJSDate(c);
          obj[headers[i]] = v;
        });
        return obj;
      });
      renderTable(data);
    }

    function showPicker() {
      document.getElementById("table").style.display = "none";
      document.getElementById("file-input-wrapper").style.display = "";
      document.getElementById("file-input")
        .addEventListener("change", e => {
          const f = e.target.files[0];
          if (!f) return;
          const fr = new FileReader();
          fr.onload = ev => processWorkbook(ev.target.result);
          fr.readAsArrayBuffer(f);
        });
    }

    function initApp() {
      fetch("surfer_updates.xlsx")
        .then(r => {
          if (!r.ok) throw new Error(r.statusText);
          return r.arrayBuffer();
        })
        .then(processWorkbook)
        .catch(err => {
          console.warn("Auto-load failed:", err);
          showPicker();
        });
    }
  </script>
</body>
</html>
